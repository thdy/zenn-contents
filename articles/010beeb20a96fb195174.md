---
title: "Azure AD Join & Intune 環境のキッティングとライセンスの考え方メモ"
emoji: "📝"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["Intune", "ems", "azuread"]
published: false
---
## この記事は
- Azure AD Join & Intune な環境で Windows 10 をキッティングする時のセオリーとかライセンスの扱いが分からなくて調べたことのメモです
- そもそも Intune や Autopilot、Azure AD Join が何かについては割愛しています
- 間違っている部分などあればご指摘やコメントいただけると嬉しいです🙏

## Azure AD Join デバイスは誰がどうキッティングする前提なのか
基本的にエンドユーザーがやる or Autopilot でやるものらしい

- Microsoft ウェビナー資料 [Azure AD の新しいデバイス管理パターンを理解しよう](https://azureadwebinar.blob.core.windows.net/contents/Azure%20AD%20-%20Modern%20Device%20Management.pptx) より引用
![](https://storage.googleapis.com/zenn-user-upload/vp43slvxhk18h35rp219j6e0d22z)

- つまり IT 管理者がユーザーに代わって事前にサインインしてポチポチキッティングするものでは無いということ
- Microsoft 的には IT 管理者がキッティングするなら Autopilot (Intune) を使おうねという思想である

## Intune のライセンスの考え方

Intune による管理を実行するためのコンソールである Microsoft Endpoint Manager 上のデバイスページには `プライマリ ユーザー` と  `登録者` という属性値がある。Intune のライセンス管理を理解する上でまずこれが何なのかを調べる必要があった。

![](https://storage.googleapis.com/zenn-user-upload/lal120esapvlnszbzqx5xzw6hjy8)

- **プライマリ ユーザー とは**
    - [Microsoft Intune デバイスのプライマリ ユーザーを確認する。 | Microsoft Docs](https://docs.microsoft.com/ja-jp/mem/intune/remote-actions/find-primary-user)
        > プライマリ ユーザーは、"ユーザーとデバイスのアフィニティ" とも呼ばれ、各 Intune デバイスのプロパティです。 Intune デバイスには、0 人または 1 人のプライマリ ユーザーを割り当てることができます。 プライマリ ユーザーが割り当てられていない場合、そのデバイスは "共有デバイス" と呼ばれます。

        > プライマリ ユーザー プロパティは、ライセンスが付与された Intune ユーザーをデバイスにマップするために以下で使用されます。
        > ポータル サイト アプリ
        > エンドユーザー Web サイト
        > Azure portal のトラブルシューティング ページなどの IT プロフェッショナルのエクスペリエンス。 これらのページでは、プライマリ ユーザーを使用してユーザー アカウントをデバイスにマップします。
    - つまりプライマリ ユーザーが割当てられてなければ
        -  Intune のライセンスは適用されない（デバイスライセンスを持っていればそちらが適用されるし持って無ければたぶんライセンス違反になる）
        - 条件付きアクセスが使えなかったり、ユーザーベースのポリシーが当たらない
    - なおプライマリ ユーザーは後から変更できる
    ![](https://storage.googleapis.com/zenn-user-upload/2f2ntyuwxad9hwwyiwuihrvrespg)

- **登録者 とは**
  - Intune のライセンス上、デバイスの登録は最大でも 15 台までしかできないという制約があるが、それのカウントをするための存在っぽい（他で使われているような説明が見当たらない）
  - [Microsoft Intune ライセンスを割り当てる | Microsoft Docs](https://docs.microsoft.com/ja-jp/mem/intune/fundamentals/licenses-assign) より引用
    > ユーザー ソフトウェア ライセンスが割り当てられた各 ユーザー は、オンライン サービスと関連するソフトウェア (System Center ソフトウェアを含む) にアクセスしてそれらを使用し、複数のアプリケーションと最大 15 台の MDM デバイスを管理できます。
  - Microsoft Endpoint Manager の画面で デバイス -> 登録制限 -> ではデフォルト 5 台までとなっており、新たにポリシーを作ろうとしても 15 までしか選べない
  - ちなみに**登録者はプライマリ ユーザーと違って後から変更できない**


なので IT 管理者が自分のアカウントを使ってユーザーの代わりに Azure AD Join とかしてるとすぐに 15 台の制限にひっかかってしまう。


とすると、

## 大量の PC を事前キッティングしたい IT 管理者はどうするべきなのか？
- デバイス登録マネージャー (DEM) アカウントを使用するのが正しいっぽい
    - [デバイス登録マネージャー アカウントを使用してデバイスを登録する - Microsoft Intune | Microsoft Docs](https://docs.microsoft.com/ja-jp/mem/intune/enrollment/device-enrollment-manager-enroll)
        > デバイス登録マネージャー (DEM) アカウントを使用することで、1 つの Azure Active Directory アカウントで最大 1,000 台のモバイル デバイスを登録できます。 DEM は、Azure AD ユーザー アカウントに適用できる Intune アクセス許可で、**ユーザーは最大 1,000 台のデバイスを登録できます。** DEM アカウントは、デバイスのユーザーに渡される前にデバイスの登録と準備を行うシナリオで役立ちます。 設計上、Microsoft Intune では、デバイス登録マネージャー (DEM) アカウントは 150 個までに制限されています。
- 既存ユーザー（IT管理者など）を DEM アカウントに設定することもできるけど退職時のことを考えると Intune のライセンスを一人ぶん消費してでも DEM 専用のアカウントを作成したほうが良いと思われる


## 現実的にどうするのがいいのか
- Autopilot ですべてうまく回ってる組織は特に何も考えなくて良さそう
  - White Glove も駆使すれば事前にアプリインストールも済ませられるのでだいぶ現実的な選択肢になってきた
- 何らかの事情で Autopilot でキッティングできない場合
  - 管理者とはいえ人のアカウントに成り代わってサインインするのはよくないよ！ ~~新規ユーザー (入社時に貸与する PC ) のキッティングなら普通に本人のアカウントでサインインしてキッティングすればいいし既存ユーザー (PC 入れ替え時) は[一時アクセスパス](https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-authentication-temporary-access-pass)を使えばいいと思う~~
  - デバイス登録マネージャー (DEM) アカウントを使ってサインインする
    - ローカル Administrators グループに実際の利用者を追加する
      - コマンドプロンプトか PowerShell で `net localgroup administrators /add "AzureAD\hoge@yourdomain.example"` を実行する
    - Intune 上でプライマリユーザーを利用者に変更する
    - 加えて利用者には初回サインイン画面で「他のユーザーでサインイン」を選択して自分の ID / パスワードを入力してもらうようアナウンスが必要
