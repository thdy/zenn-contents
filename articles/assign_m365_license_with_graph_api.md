---
title: "Microsoft Graph APIã‚’ä½¿ã£ã¦Microsoft 365ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä»˜ä¸ã™ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["api", "azure", "nodejs"]
published: false
---
# ã¯ã˜ã‚ã«
Slackä¸Šã§ç”³è«‹æ‰¿èªãŒå®Œäº†ã™ã‚‹ã¨è‡ªå‹•çš„ã«SaaSã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä»˜ä¸ã™ã‚‹Bolt.jsè£½ã®Slack Appã‚’ç¤¾å†…ã§é‹ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãã“ã«Microsoft 365ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä»˜ä¸ã™ã‚‹å‡¦ç†ã‚’çµ„ã¿è¾¼ã‚“ã éš›ã®ãƒ¡ãƒ¢ã§ã™ã€‚

# Microsoft Graphã¨ã¯
Microsoft Graphã¯ã€Microsoft 365ã€Windows 10ã€ãŠã‚ˆã³Enterprise Mobility + Securityã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ–ãƒ«ã«æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
ä»Šå›ã¯Microsoft GraphãŒæä¾›ã™ã‚‹APIã‚’ä½¿ç”¨ã—ã¦Azure ADä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
> [Microsoft Graph ã®æ¦‚è¦ - Microsoft Graph | Microsoft Docs](https://docs.microsoft.com/ja-jp/graph/overview)
> ![](https://storage.googleapis.com/zenn-user-upload/9d24d0d93098d6d6b5bfe462.png)

# èªè¨¼ã¨èªå¯
é€šå¸¸ITæ‹…å½“è€…ãªã©ã®äººé–“ãŒMicrosoft 365ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä»˜ä¸ã™ã‚‹éš›ã«ã¯ã¾ãšAzure Active Directoryï¼ˆä»¥ä¸‹ Azure ADï¼‰ã§ã®èªè¨¼ãŒå®Œäº†ã—ã¦ãŠã‚Šã€ãã®èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ç®¡ç†ã§ãã‚‹æ¨©é™ãŒèªå¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æã¨ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯äººé–“ã«ä»£ã‚ã£ã¦ã‚¢ãƒ—ãƒªã«ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä»˜ä¸ã—ã¦ã‚‚ã‚‰ã†ãŸã‚ã€ãã®æ¨©é™ã‚’ã‚¢ãƒ—ãƒªã«æŒãŸã›ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚
ã ã‚Œã§ã‚‚å®Ÿè¡Œã§ãã¦ã¯å›°ã‚‹ã®ã§ãã®ã‚¢ãƒ—ãƒªã¯æœ¬å½“ã«æ­£è¦ã®ã‚¢ãƒ—ãƒªãªã®ã‹ã€æ¨©é™ã‚’èªå¯ã—ã¦è‰¯ã„ã‹ã‚’èªè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®èªè¨¼æƒ…å ±ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚Azure ADä¸Šã«ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã—ã€ã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦é©åˆ‡ãªæ¨©é™ã‚’èªå¯ã—ã¾ã™ã€‚

# Microsoft Azure portalã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã™ã‚‹
Azure ADã®ç®¡ç†ç”»é¢ã§ `ã‚¢ãƒ—ãƒªã®ç™»éŒ²` > `æ–°è¦ç™»éŒ²` ã‚’é¸æŠã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/3bee6caa49449098dd6d195b.png)

é©å½“ãªåå‰ã‚’ä»˜ã‘ã¦ã‚¢ãƒ—ãƒªã®å…¬é–‹ç¯„å›²ã‚’é¸æŠã—ã€ç™»éŒ²ã‚’é¸æŠã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/10f555f65bcc0972da93a9a3.png)

## ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç”Ÿæˆ
æ¬¡ã«èªè¨¼ã«ç”¨ã„ã‚‹ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã€`è¨¼æ˜æ›¸ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ` ã®ç”»é¢ã§ `æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ` ã‚’é¸æŠã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/14f6db09a52c7e2821242cd3.png)

é©å½“ãªèª¬æ˜ã‚’å…¥åŠ›ã—ã¦æœ‰åŠ¹æœŸé™ã‚’é¸æŠã— `è¿½åŠ ` ã‚’é¸æŠã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/5aadd7f660e1fa5d46a6b1a1.png)

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®å€¤ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆIDãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ãƒ„ãƒ¼ãƒ«ãªã©é©åˆ‡ãªæ‰‹æ®µã§ç®¡ç†ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/2c2ea1061480ebd0aad224e0.png)

:::message
**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æœŸé™ã¯24ã‹æœˆä»¥ä¸Šã«ã§ãã‚‹ï¼Ÿ**
å¾“æ¥ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æœ‰åŠ¹æœŸé™ã¯ç„¡åˆ¶é™ã«ã‚‚ã§ãã¾ã—ãŸãŒ2021å¹´4æœˆã‚ˆã‚Šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‡¸å¿µãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§æœ€é•·ã§ã‚‚24ã‹æœˆã¸å¤‰æ›´ã«ãªã‚Šã€å‰è¿°ã®ç”»åƒé€šã‚ŠGUIã‹ã‚‰ã ã¨24ã‹æœˆã¾ã§ã—ã‹é¸æŠã§ãã¾ã›ã‚“ã€‚
2021å¹´7æœˆç¾åœ¨ã€PowerShellã‹ã‚‰ç™ºè¡Œã™ã‚‹å ´åˆã¯å¾“æ¥ã©ãŠã‚Šç„¡åˆ¶é™ã«ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ãŒã“ã‚Œã¯GUIåŒæ§˜ã®åˆ¶é™ãŒå…¥ã‚‹äºˆå®šã¨ãªã£ã¦ã„ã¾ã™ã€‚

[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆç”»é¢ã®å¤‰æ›´ã«ã¤ã„ã¦ | Japan Azure Identity Support Blog](https://jpazureid.github.io/blog/azure-active-directory/azuread-clientsecrets-202104/#PowerShell-%E3%81%8B%E3%82%89%E3%81%AF%E3%80%81%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%81%8C-2-%E5%B9%B4%E4%BB%A5%E4%B8%8A%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B7%E3%83%BC%E3%82%AF%E3%83%AC%E3%83%83%E3%83%88%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%A7%E3%81%99%E3%81%8C%E2%80%A6)
> ç¾åœ¨ã¯ PowerShell ã‚³ãƒãƒ³ãƒ‰ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹éš›ã¯ã€2 å¹´ä»¥ä¸Šã®æœ‰åŠ¹æœŸé™ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
> ï¼ˆä¸­ç•¥ï¼‰
> ãŸã ã—ã€ã„ãšã‚Œã¯ PowerShell ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆã«ã‚‚ã€Azure ãƒãƒ¼ã‚¿ãƒ«ä¸Šã¨åŒã˜åˆ¶é™ãŒã‹ã‹ã‚‹ã‚ˆã†ã«ãªã‚‹æ–¹é‡ã§ã™ (åˆ¶é™ãŒåæ˜ ã•ã‚ŒãŸéš›ã«ã¯ã€ã“ã®é …ç›®ã¯å‰Šé™¤ã™ã‚‹äºˆå®šã§ã™)ã€‚ã“ã®åˆ¶é™ãŒå®Ÿæ–½ã•ã‚Œã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯ã€ç¾æ™‚ç‚¹ã§ã¯æœªå®šã§ã™ã€‚
:::

## ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®ä»˜ä¸
ç¶šã„ã¦ã€ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã«å¿…è¦ãªæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
ä»Šå›ä½¿ç”¨ã™ã‚‹ `assignLicense` ã¨ã„ã†APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¤ã„ã¦ã€Microsoftã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å¿…è¦ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ç¢ºèªã—ã¾ã™ã€‚

> [assignLicense - Microsoft Graph v1.0 | Microsoft Docs](https://docs.microsoft.com/ja-jp/graph/api/user-assignlicense?view=graph-rest-1.0&tabs=http#permissions)
> |ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®ç¨®é¡ | ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ (ç‰¹æ¨©ã®å°ã•ã„ã‚‚ã®ã‹ã‚‰å¤§ãã„ã‚‚ã®ã¸)|
> |---|---|
> |å§”ä»» (è·å ´ã¾ãŸã¯å­¦æ ¡ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)|User.ReadWrite.Allã€Directory.ReadWrite.All|
> |å§”ä»» (å€‹äººç”¨ Microsoft ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)|ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚|
> |ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³|User.ReadWrite.Allã€Directory.ReadWrite.All|


å®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã€ `API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯` > `ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®è¿½åŠ ` ã‚’é¸æŠã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/170697b1943b3fea86dee64f.png)

`Microsoft Graph` ã‚’é¸æŠ
![](https://storage.googleapis.com/zenn-user-upload/f7d02cdf9dfc2dcf5dac6547.png)

`ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨±å¯` ã‚’é¸æŠ
![](https://storage.googleapis.com/zenn-user-upload/851df6cfe7b48082f650a948.png)

å…ˆç¨‹ç¢ºèªã—ãŸã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã§ã‚ã‚‹ `User.ReadWrite.All` ã¨ `Directory.ReadWrite.All` ã‚’æ¤œç´¢ã—ã¦è¿½åŠ ã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/cd25a0acf5d2fe91c565cacb.png)

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ä¸­ã§ç®¡ç†è€…ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ç™ºç”Ÿã•ã›ãŸããªã„å ´åˆã¯ã‚ã‚‰ã‹ã˜ã‚ç®¡ç†è€…ã®åŒæ„ã‚’ä¸ãˆã¦ãŠãã¾ã™ã€‚ã“ã“ã¯è¦ä»¶ã«å¿œã˜ã¦é¸æŠã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/6d4d9575d589346a0fc1bc54.png)

ä»¥ä¸Šã§æ¨©é™ä»˜ä¸ã‚‚å®Œäº†ã—ã¾ã—ãŸã€‚

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
å®Ÿéš›ã«ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸ã®APIã‚’å®Ÿè¡Œã™ã‚‹éš›ã®èªè¨¼ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã¨ãªã‚‹ã®ã§ã€å‰è¿°ã®æ‰‹é †ã§ç”Ÿæˆã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆIDã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚

ä¸‹è¨˜ã¯curlã§å–å¾—ã™ã‚‹éš›ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚
```shell
curl -d "client_id=$MSGRAPH_CLIENT_ID" \
 -d "scope=https%3A%2F%2Fgraph.microsoft.com%2F.default" \
 -d client_secret=$MSGRAPH_CLIENT_SECRET \
 -d "grant_type=client_credentials" \
 -H "Content-Type: application/x-www-form-urlencoded" \
 -X POST https://login.microsoftonline.com/$MY_AZUREAD_DOMAIN/oauth2/v2.0/token
 ```
